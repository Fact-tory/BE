# =================================
# Factory BE PR Check
# PR ê²€ì¦ì„ ìœ„í•œ ì „ìš© ì›Œí¬í”Œë¡œìš°
# =================================

name: PR Check

on:
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened]

# PRë³„ë¡œ í•˜ë‚˜ì”©ë§Œ ì‹¤í–‰
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  # =================================
  # PR ì •ë³´ ë° ë³€ê²½ì‚¬í•­ ë¶„ì„
  # =================================
  pr-info:
    name: PR Analysis
    runs-on: ubuntu-latest
    outputs:
      has-java-changes: ${{ steps.changes.outputs.java }}
      has-test-changes: ${{ steps.changes.outputs.test }}
      has-gradle-changes: ${{ steps.changes.outputs.gradle }}
      has-docker-changes: ${{ steps.changes.outputs.docker }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    # ë³€ê²½ëœ íŒŒì¼ ìœ í˜• ë¶„ì„
    - name: Detect changes
      id: changes
      uses: dorny/paths-filter@v2
      with:
        filters: |
          java:
            - 'src/main/java/**/*.java'
          test:
            - 'src/test/java/**/*.java'
          gradle:
            - 'build.gradle'
            - 'gradle/**'
            - 'gradlew*'
          docker:
            - 'Dockerfile'
            - 'docker-compose*.yml'
            - '.dockerignore'
    
    # PR í¬ê¸° ë¶„ì„
    - name: Analyze PR size
      run: |
        CHANGED_FILES=$(git diff --name-only origin/main...HEAD | wc -l)
        LINES_ADDED=$(git diff --shortstat origin/main...HEAD | awk '{print $4}')
        LINES_DELETED=$(git diff --shortstat origin/main...HEAD | awk '{print $6}')
        
        echo "Changed files: $CHANGED_FILES"
        echo "Lines added: ${LINES_ADDED:-0}"
        echo "Lines deleted: ${LINES_DELETED:-0}"
        
        if [ "$CHANGED_FILES" -gt 50 ]; then
          echo "âš ï¸ Large PR detected ($CHANGED_FILES files changed)"
          echo "Consider splitting this PR into smaller changes"
        fi

  # =================================
  # Java ì½”ë“œ ë³€ê²½ì‹œ ì»´íŒŒì¼ ë° í…ŒìŠ¤íŠ¸
  # =================================
  java-check:
    name: Java Code Check
    runs-on: ubuntu-latest
    needs: pr-info
    if: needs.pr-info.outputs.has-java-changes == 'true' || needs.pr-info.outputs.has-test-changes == 'true'
    
    services:
      # ê²½ëŸ‰í™”ëœ í…ŒìŠ¤íŠ¸ í™˜ê²½
      redis:
        image: redis:7.0-alpine
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
        ports:
          - 6379:6379
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Setup Gradle
      uses: gradle/gradle-build-action@v2
    
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
    
    # ë³€ê²½ëœ íŒŒì¼ë§Œ ì»´íŒŒì¼ ì²´í¬ (ìµœì í™”)
    - name: Compile changed code
      run: ./gradlew compileJava compileTestJava
    
    # í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (ë³‘ë ¬)
    - name: Run tests
      run: ./gradlew test -Dspring.profiles.active=test --parallel
      env:
        SPRING_PROFILES_ACTIVE: test
        REDIS_HOST: localhost
        REDIS_PORT: 6379
        JWT_SECRET_KEY: test-pr-jwt-secret-32-characters
        ENCRYPTION_SECRET_KEY: test-pr-encryption-key-32chars
        ADMIN_MASTER_TOKEN: test-pr-admin
        ADMIN_TOKEN_IDENTIFIER: test-admin
    
    # í…ŒìŠ¤íŠ¸ ê²°ê³¼ ëŒ“ê¸€ ì‘ì„±
    - name: Comment test results
      if: always()
      uses: dorny/test-reporter@v1
      with:
        name: Test Results
        path: build/test-results/test/*.xml
        reporter: java-junit
        fail-on-error: false

  # =================================
  # ë¹Œë“œ ì‹œìŠ¤í…œ ë³€ê²½ ê²€ì¦
  # =================================
  build-check:
    name: Build System Check
    runs-on: ubuntu-latest
    needs: pr-info
    if: needs.pr-info.outputs.has-gradle-changes == 'true'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Validate Gradle wrapper
      uses: gradle/wrapper-validation-action@v1
    
    - name: Setup Gradle
      uses: gradle/gradle-build-action@v2
    
    # ì˜ì¡´ì„± ì²´í¬
    - name: Check dependencies
      run: |
        ./gradlew dependencies --configuration compileClasspath
        ./gradlew dependencies --configuration runtimeClasspath

    # ë¹Œë“œ ì„±ëŠ¥ ì²´í¬
    - name: Build performance test
      run: |
        time ./gradlew clean build -x test
        echo "Build completed successfully"

  # =================================
  # Docker ê´€ë ¨ ë³€ê²½ ê²€ì¦
  # =================================
  docker-check:
    name: Docker Check
    runs-on: ubuntu-latest
    needs: pr-info
    if: needs.pr-info.outputs.has-docker-changes == 'true'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    # Dockerfile ë¬¸ë²• ì²´í¬
    - name: Lint Dockerfile
      uses: hadolint/hadolint-action@v3.1.0
      with:
        dockerfile: Dockerfile
        format: sarif
        output-file: hadolint-results.sarif
        no-fail: true
    
    # Docker ì´ë¯¸ì§€ ë¹Œë“œ í…ŒìŠ¤íŠ¸
    - name: Build Docker image
      run: |
        # ë¹Œë“œ ê°€ëŠ¥í•œì§€ë§Œ í™•ì¸ (í‘¸ì‹œ ì•ˆí•¨)
        docker build -t factory-be:pr-test .
    
    # Docker Compose ê²€ì¦
    - name: Validate docker-compose
      if: needs.pr-info.outputs.has-docker-changes == 'true'
      run: |
        docker-compose -f docker-compose.yml config
        docker-compose -f docker-compose.dev.yml config

  # =================================
  # ì „ì²´ PR ìƒíƒœ ìš”ì•½
  # =================================
  pr-summary:
    name: PR Summary
    runs-on: ubuntu-latest
    needs: [pr-info, java-check, build-check, docker-check]
    if: always()
    
    steps:
    - name: Create PR summary comment
      uses: actions/github-script@v7
      with:
        script: |
          const { owner, repo } = context.repo;
          const pr_number = context.payload.pull_request.number;
          
          let summary = "## ğŸ” PR Check Summary\n\n";
          
          // ì²´í¬ ê²°ê³¼ ìš”ì•½
          const results = [
            { name: "Java Code", job: "${{ needs.java-check.result }}" },
            { name: "Build System", job: "${{ needs.build-check.result }}" },
            { name: "Docker", job: "${{ needs.docker-check.result }}" }
          ];
          
          results.forEach(result => {
            if (result.job === 'success') {
              summary += `âœ… ${result.name} - í†µê³¼\n`;
            } else if (result.job === 'failure') {
              summary += `âŒ ${result.name} - ì‹¤íŒ¨\n`;
            } else if (result.job === 'skipped') {
              summary += `â­ï¸ ${result.name} - ê±´ë„ˆëœ€\n`;
            }
          });
          
          summary += `\n**ë³€ê²½ì‚¬í•­:**\n`;
          summary += `- Java íŒŒì¼: ${{ needs.pr-info.outputs.has-java-changes == 'true' && 'ë³€ê²½ë¨' || 'ë³€ê²½ ì—†ìŒ' }}\n`;
          summary += `- í…ŒìŠ¤íŠ¸ íŒŒì¼: ${{ needs.pr-info.outputs.has-test-changes == 'true' && 'ë³€ê²½ë¨' || 'ë³€ê²½ ì—†ìŒ' }}\n`;
          summary += `- Gradle ì„¤ì •: ${{ needs.pr-info.outputs.has-gradle-changes == 'true' && 'ë³€ê²½ë¨' || 'ë³€ê²½ ì—†ìŒ' }}\n`;
          summary += `- Docker ì„¤ì •: ${{ needs.pr-info.outputs.has-docker-changes == 'true' && 'ë³€ê²½ë¨' || 'ë³€ê²½ ì—†ìŒ' }}\n`;
          
          // ê¸°ì¡´ ëŒ“ê¸€ ì°¾ê¸°
          const comments = await github.rest.issues.listComments({
            owner,
            repo,
            issue_number: pr_number,
          });
          
          const botComment = comments.data.find(comment => 
            comment.user.type === 'Bot' && 
            comment.body.includes('PR Check Summary')
          );
          
          // ëŒ“ê¸€ ì—…ë°ì´íŠ¸ ë˜ëŠ” ìƒì„±
          if (botComment) {
            await github.rest.issues.updateComment({
              owner,
              repo,
              comment_id: botComment.id,
              body: summary
            });
          } else {
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: pr_number,
              body: summary
            });
          }